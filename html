import { t } from '../trpc'; // Khởi tạo router với tRPC
import { z } from 'zod'; // Thư viện giúp validate dữ liệu input

// Helper function để lấy employees từ localStorage
const getEmployeesFromLocalStorage = () => {
  const data = localStorage.getItem('employees');
  return data ? JSON.parse(data) : [];
};

// Helper function để lưu employees vào localStorage
const saveEmployeesToLocalStorage = (employees: any[]) => {
  localStorage.setItem('employees', JSON.stringify(employees));
};

// Định nghĩa các procedure cho router `employee`
export const employeeRouter = t.router({
  // Procedure lấy tất cả các employee
  getAll: t.procedure.query(() => {
    return getEmployeesFromLocalStorage(); // Trả về danh sách employee từ localStorage
  }),

  // Procedure lấy chi tiết một employee dựa vào ID
  getById: t.procedure.input(z.number()).query(({ input }) => {
    const employees = getEmployeesFromLocalStorage();
    const employee = employees.find(emp => emp.id === input);
    if (!employee) throw new Error('Employee not found');
    return employee;
  }),

  // Procedure tạo mới một employee, với input validation
  create: t.procedure
    .input(z.object({
      name: z.string(), 
      age: z.number(),
      position: z.string(),
    }))
    .mutation(({ input }) => {
      const employees = getEmployeesFromLocalStorage();
      const newEmployee = {
        id: employees.length ? employees[employees.length - 1].id + 1 : 1, // Tạo ID mới
        ...input,
      };
      employees.push(newEmployee); // Thêm employee mới vào danh sách
      saveEmployeesToLocalStorage(employees); // Lưu lại vào localStorage
      return newEmployee;
    }),

  // Procedure chỉnh sửa thông tin employee
  update: t.procedure
    .input(z.object({
      id: z.number(),
      name: z.string().optional(),
      age: z.number().optional(),
      position: z.string().optional(),
    }))
    .mutation(({ input }) => {
      const employees = getEmployeesFromLocalStorage();
      const index = employees.findIndex(emp => emp.id === input.id);
      if (index === -1) throw new Error('Employee not found');
      
      employees[index] = {
        ...employees[index],
        ...input,
      };
      saveEmployeesToLocalStorage(employees); // Lưu lại vào localStorage
      return employees[index];
    }),

  // Procedure xóa employee
  delete: t.procedure.input(z.number()).mutation(({ input }) => {
    const employees = getEmployeesFromLocalStorage();
    const index = employees.findIndex(emp => emp.id === input);
    if (index === -1) throw new Error('Employee not found');
    
    const [removedEmployee] = employees.splice(index, 1); // Xóa employee khỏi danh sách
    saveEmployeesToLocalStorage(employees); // Lưu lại vào localStorage
    return removedEmployee;
  }),
});
